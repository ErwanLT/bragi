<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>LE DERNIER DUEL</title>
    <link rel="stylesheet" href="../style/western.css">
    <script>
        document.addEventListener('keydown', function (event) {
            if (event.key === 'F12' || event.keyCode === 123 ||
                (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key)) ||
                (event.metaKey && event.altKey && ['I', 'J', 'C'].includes(event.key))) {
                event.preventDefault();
                window.location.href = "../magic_word.html";
            }
        });
    </script>
    <script>
        const variables = { fortune: 50, honneur: 50, munitions: 6 };
        const choices = {};

        function updateDisplay() {
            const hud = document.getElementById('hud');
            if (hud) {
                hud.innerHTML = `
                    <div><span>FORTUNE:</span> <span>$${variables.fortune}</span></div>
                    <div><span>HONNEUR:</span> <span>${variables.honneur}</span></div>
                    <div><span>MUNITIONS:</span> <span>${variables.munitions} ⦾</span></div>
                `;
            }
        }

        function applyChoice(btn) {
            const section = btn.closest('.section');
            const sections = Array.from(document.querySelectorAll('.section'));
            const index = sections.indexOf(section);

            // Get new values
            const f = Number(btn.dataset.fortune || 0);
            const h = Number(btn.dataset.honneur || 0);
            const m = Number(btn.dataset.munitions || 0);

            // Store choice
            choices[index] = { fortune: f, honneur: h, munitions: m };

            // Visual update
            section.querySelectorAll('.choice').forEach(b => {
                b.classList.remove('selected');
            });
            btn.classList.add('selected');

            recalculateState();

            // Scroll to next section if exists
            if (sections[index + 1]) {
                sections[index + 1].scrollIntoView({ behavior: 'smooth' });
            }
        }

        function recalculateState() {
            variables.fortune = 50;
            variables.honneur = 50;
            variables.munitions = 6;

            const sortedIndices = Object.keys(choices).sort((a, b) => Number(a) - Number(b));

            for (const idx of sortedIndices) {
                const choice = choices[idx];
                variables.fortune += choice.fortune;
                variables.honneur += choice.honneur;
                variables.munitions += choice.munitions;
            }

            // Clamp
            variables.fortune = Math.max(0, variables.fortune);
            variables.honneur = Math.max(0, Math.min(100, variables.honneur));
            variables.munitions = Math.max(0, variables.munitions);

            updateDisplay();
        }

        function computeEnding(forceEnding) {
            let title = 'LE SOLEIL SE COUCHE';
            let text = 'L\'histoire se termine ici.';
            let color = '#5d4037';

            if (forceEnding === 'rich') {
                title = 'RETRAITE DORÉE';
                text = 'Avec tout cet or, vous achetez un ranch au Mexique. Adieu la vie de chasseur de primes.';
                color = '#ffb300';
            } else if (variables.munitions <= 0) {
                title = 'CLICK... CLICK...';
                text = 'Votre barillet est vide. Le bandit sourit. C\'est la fin pour vous, gringo.';
                color = '#d84315';
            } else if (variables.honneur <= 10) {
                title = 'HORS-LA-LOI';
                text = 'Vous avez tué le bandit, mais vous êtes devenu comme lui. Votre tête est mise à prix.';
                color = '#3e2723';
            } else if (variables.honneur >= 90) {
                title = 'LÉGENDE DE L\'OUEST';
                text = 'Vous ramenez le bandit vivant. Le shérif vous serre la main. Les enfants joueront à être vous.';
                color = '#ffd700';
            } else {
                title = 'JUSTICE EST FAITE';
                text = 'Une prime empochée, une tombe creusée. Juste une autre journée dans l\'Ouest.';
                color = '#8d6e63';
            }

            const story = document.getElementById('story');
            const oldEnding = document.getElementById('ending-block');
            if (oldEnding) oldEnding.remove();

            story.insertAdjacentHTML('beforeend', `
                <div id="ending-block" style="margin-top:40px; border-top: 2px dashed #5d4037; padding-top: 20px; animation: fadeIn 2s;">
                    <h2 style="color:${color}; margin-bottom: 20px; border:none;">${title}</h2>
                    <p style="text-align:center; font-style:italic;">${text}</p>
                    <div style="text-align:center; margin-top:20px;">
                        <a href="duel.html" style="color: #5d4037; text-decoration: none; border-bottom: 1px solid #5d4037;">Recharger la partie</a>
                    </div>
                </div>
            `);

            // Scroll to ending
            setTimeout(() => {
                document.getElementById('ending-block').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.section').forEach(section => {
                section.querySelectorAll('.choice').forEach(btn => {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('choice-wrapper');

                    const f = Number(btn.dataset.fortune || 0);
                    const h = Number(btn.dataset.honneur || 0);
                    const m = Number(btn.dataset.munitions || 0);

                    const effects = [];
                    if (f < 0) effects.push(`-$${Math.abs(f)}`);
                    if (h < 0) effects.push(`Honneur ${h}`);
                    if (m < 0) effects.push(`Balle ${m}`);
                    if (f > 0) effects.push(`+$${f}`);
                    if (h > 0) effects.push(`Honneur +${h}`);
                    if (m > 0) effects.push(`Balle +${m}`);

                    wrapper.dataset.info = effects.join(' / ') || '';
                    btn.parentNode.insertBefore(wrapper, btn);
                    wrapper.appendChild(btn);
                });
            });
            updateDisplay();
        });
    </script>
</head>

<body>
    <div id="hud"></div>
    <div class="quest-card">
        <h3>★ LE DERNIER DUEL ★</h3>
        <p style="text-align:center; font-style: italic; color: #8d6e63;">WANTED: "El Cascabel" - Dead or Alive</p>

        <div id="story">
            <!-- 1. SALOON -->
            <div class="section">
                <p><strong>12:00 - Coyote Creek Saloon</strong></p>
                <p>La ville est déserte, sauf le saloon. La poussière tourbillonne. Vous entrez. Le barman nettoie un
                    verre crasseux.</p>
                <button class="choice" data-fortune="-5" onclick="applyChoice(this)">Payer un verre pour avoir des
                    infos.</button>
                <button class="choice" data-honneur="-10" onclick="applyChoice(this)">Intimider le barman avec votre
                    Colt.</button>
            </div>

            <!-- 2. POKER -->
            <div class="section">
                <p><strong>12:30 - Partie de Poker</strong></p>
                <p>Trois types patibulaires vous invitent à leur table. L'un d'eux connaît El Cascabel.</p>
                <button class="choice" data-fortune="+50" data-honneur="-10" onclick="applyChoice(this)">Tricher (As
                    dans la manche).</button>
                <button class="choice" data-fortune="-20" data-honneur="+10" onclick="applyChoice(this)">Jouer honnête
                    (Perdre mais gagner leur respect).</button>
            </div>

            <!-- 3. BAGARRE -->
            <div class="section">
                <p><strong>13:00 - La Bagarre</strong></p>
                <p>La triche (ou la chance) ne plaît pas à tout le monde. Une bouteille vole.</p>
                <button class="choice" data-munitions="-1" onclick="applyChoice(this)">Tirer en l'air pour calmer tout
                    le monde.</button>
                <button class="choice" data-honneur="+5" onclick="applyChoice(this)">Se battre aux poings (Économiser
                    les balles).</button>
            </div>

            <!-- 4. L'ÉCURIE -->
            <div class="section">
                <p><strong>13:45 - L'Écurie Abandonnée</strong></p>
                <p>Vous cherchez des provisions. Un vieux cheval borgne vous regarde.</p>
                <button class="choice" data-munitions="+6" onclick="applyChoice(this)">Fouiller la selle du shérif mort
                    (Trouver des balles).</button>
                <button class="choice" data-fortune="-10" data-honneur="+10" onclick="applyChoice(this)">Donner de l'eau
                    au cheval et partir.</button>
            </div>

            <!-- 5. CANYON -->
            <div class="section">
                <p><strong>15:00 - L'Embuscade du Canyon</strong></p>
                <p>Un coup de feu résonne ! Une balle siffle à votre oreille. Ils sont en hauteur.</p>
                <button class="choice" data-munitions="-3" onclick="applyChoice(this)">Riposter intensivement (Tir de
                    couverture).</button>
                <button class="choice" data-honneur="-5" onclick="applyChoice(this)">Fuir au galop vers la
                    mine.</button>
            </div>

            <!-- 6. FEU DE CAMP -->
            <div class="section">
                <p><strong>18:00 - Bivouac Rapide</strong></p>
                <p>Vous êtes semé. Vous prenez un moment pour nettoyer votre arme et manger des haricots froids.</p>
                <button class="choice" data-honneur="+10" onclick="applyChoice(this)">Se remémorer pourquoi on se bat
                    (Justice).</button>
                <button class="choice" data-munitions="+2" onclick="applyChoice(this)">Recalibrer le viseur et récupérer
                    des balles perdues.</button>
            </div>

            <!-- 7. LA MINE -->
            <div class="section">
                <p><strong>19:30 - L'Entrée de la Mine</strong></p>
                <p>El Cascabel se cache là-dedans. C'est un labyrinthe.</p>
                <button class="choice" data-fortune="+100" onclick="applyChoice(this)">Explorer une veine d'or
                    (Cupidité).</button>
                <button class="choice" data-honneur="+5" onclick="applyChoice(this)">Suivre les traces de bottes (La
                    mission d'abord).</button>
            </div>

            <!-- 8. RUE PRINCIPALE -->
            <div class="section">
                <p><strong>20:00 - Retour en Ville</strong></p>
                <p>Il vous a contourné. Il vous attend dans la rue principale. Le vent souffle.</p>
                <button class="choice" data-honneur="+10" onclick="applyChoice(this)">Sortir à découvert ("Viens te
                    battre !").</button>
                <button class="choice" data-honneur="-20" data-munitions="-1" onclick="applyChoice(this)">Tirer depuis
                    l'ombre (Lâche).</button>
            </div>

            <!-- 9. L'église -->
            <div class="section">
                <p><strong>20:15 - Les Ruines de l'Église</strong></p>
                <p>Il s'est replié dans l'église. Il a un otage.</p>
                <button class="choice" data-munitions="-2" data-honneur="+20" onclick="applyChoice(this)">Tirer une
                    balle impossible pour désarmer.</button>
                <button class="choice" data-fortune="+50" data-honneur="-50" onclick="applyChoice(this)">Négocier :
                    "Partageons le butin de la banque".</button>
            </div>

            <!-- 10. FACE A FACE -->
            <div class="section">
                <p><strong>20:30 - Face à Face</strong></p>
                <p>L'otage s'enfuit. Il ne reste que vous deux. Le soleil rouge touche l'horizon.</p>
                <button class="choice" data-munitions="-1" onclick="applyChoice(this)">Dégainer le premier !</button>
                <button class="choice" data-honneur="+10" onclick="applyChoice(this)">Attendre qu'il bouge...</button>
            </div>

            <!-- 11. LE DERNIER COUP -->
            <div class="section">
                <p><strong>20:31 - Le Coup Fatal</strong></p>
                <p>Il est à terre, blessé mais vivant. Il cherche son arme.</p>
                <button class="choice" data-honneur="-10" onclick="applyChoice(this); computeEnding()">L'achever sans
                    pitié.</button>
                <button class="choice" data-honneur="+20" onclick="applyChoice(this); computeEnding()">Lui passer les
                    menottes.</button>
                <button class="choice" data-fortune="-100" onclick="applyChoice(this); computeEnding('rich')">Partir
                    avec son or et le laisser (Si vous êtes riche).</button>
            </div>

        </div>

        <div class="navigation-footer"
            style="margin-top: 3rem; padding-top: 2rem; border-top: 2px dashed #5d4037; text-align: center;">
            <a href="../western.html" style="color: #5d4037; text-decoration: none; margin-right: 1.5rem;">&larr; Retour
                au Saloon</a>
            <a href="../index.html" style="color: #5d4037; text-decoration: none;">Menu Principal</a>
        </div>
    </div>
</body>

</html>