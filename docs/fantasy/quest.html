<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Qu√™te du Code Ancestral</title>
    <link rel="stylesheet" href="../style/fantasy.css">
    <script>
        document.addEventListener('keydown', function (event) {
            if (event.key === 'F12' || event.keyCode === 123 ||
                (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key)) ||
                (event.metaKey && event.altKey && ['I', 'J', 'C'].includes(event.key))) {
                event.preventDefault();
                window.location.href = "../magic_word.html";
            }
        });
    </script>
    <script>
        const variables = { mana: 50, xp: 0, karma: 50 };
        const choices = {}; // Stores chosen values for each section index

        function updateDisplay() {
            const hud = document.getElementById('hud');
            if (hud) {
                hud.innerHTML = `
                    <div>‚ú® MANA: ${variables.mana}</div>
                    <div>‚öîÔ∏è XP: ${variables.xp}</div>
                    <div>‚öñÔ∏è KARMA: ${variables.karma}</div>
                `;
            }
        }

        function applyChoice(btn) {
            const section = btn.closest('.section');
            const sections = Array.from(document.querySelectorAll('.section'));
            const index = sections.indexOf(section);

            // Get new values
            const m = Number(btn.dataset.mana || 0);
            const x = Number(btn.dataset.xp || 0);
            const k = Number(btn.dataset.karma || 0);

            // Store choice
            choices[index] = { mana: m, xp: x, karma: k };

            // Visual update
            section.querySelectorAll('.choice').forEach(b => {
                b.classList.remove('selected');
            });
            btn.classList.add('selected');

            recalculateState();
        }

        function recalculateState() {
            // Reset to initial
            variables.mana = 50;
            variables.xp = 0;
            variables.karma = 50;

            // Replay all choices
            const sortedIndices = Object.keys(choices).sort((a, b) => Number(a) - Number(b));

            for (const idx of sortedIndices) {
                const choice = choices[idx];
                variables.mana += choice.mana;
                variables.xp += choice.xp;
                variables.karma += choice.karma;

                // Clamp at each step to match intended game rules
                variables.mana = Math.max(0, Math.min(100, variables.mana));
                variables.karma = Math.max(0, Math.min(100, variables.karma));
            }

            updateDisplay();
            // checkProgress removed per user request
        }

        function computeEnding() {
            let title = 'Fin Inconnue';
            let text = 'Le destin est trouble...';

            // Logic for endings
            if (variables.mana <= 0) {
                title = 'üëª Fant√¥me du Commit (Burnout)';
                text = 'Votre √©nergie vitale s\'est dissip√©e. Vous errez d√©sormais dans le git log, un spectre hantant les Pull Requests abandonn√©es. Vous avez oubli√© de prendre des pauses.';
            } else if (variables.xp >= 80 && variables.karma >= 70) {
                title = 'üßô Grand Archimage (CTO L√©gendaire)';
                text = 'Vous avez vaincu le Dragon Monolithique avec √©l√©gance et sagesse. Le Code Ancestral est propre, document√©, et test√©. Les bardes chanteront vos louanges sur HackerNews.';
            } else if (variables.xp >= 60 && variables.karma <= 30) {
                title = 'üíÄ N√©cromancien du Spaghetti';
                text = 'Le Dragon est mort, mais √† quel prix ? Votre code est un labyrinthe de hacks obscurs et de magie noire. √áa marche, mais personne n\'ose relire votre travail. Vous r√©gnez sur un royaume de Chaos.';
            } else {
                title = 'üõ°Ô∏è Garde du Donjon (Le "√áa Passe")';
                text = 'Vous avez surv√©cu. Le projet est en prod. Ce n\'est pas parfait, il y a des bugs, mais le client paie. Vous √™tes un aventurier honn√™te, ni h√©ros ni vilain.';
            }

            const story = document.getElementById('story');
            const oldEnding = document.getElementById('ending-block');
            if (oldEnding) oldEnding.remove();

            story.insertAdjacentHTML('beforeend', `
                <div id="ending-block" class="section" style="border-left-color: var(--accent-magic);">
                    <h2 style="color: var(--accent-magic);">${title}</h2>
                    <p>${text}</p>
                    <div style="margin-top: 2rem; font-weight: bold;">
                        Stats Finales: Mana ${variables.mana} | XP ${variables.xp} | Karma ${variables.karma}
                    </div>
                </div>
            `);
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.section').forEach(section => {
                section.querySelectorAll('.choice').forEach(btn => {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('choice-wrapper');
                    const m = Number(btn.dataset.mana || 0);
                    const x = Number(btn.dataset.xp || 0);
                    const k = Number(btn.dataset.karma || 0);

                    const effects = [];
                    if (m !== 0) effects.push(`Mana ${m > 0 ? '+' + m : m}`);
                    if (x !== 0) effects.push(`XP ${x > 0 ? '+' + x : x}`);
                    if (k !== 0) effects.push(`Karma ${k > 0 ? '+' + k : k}`);

                    wrapper.dataset.info = effects.join(' / ') || 'Aucun effet';
                    btn.parentNode.insertBefore(wrapper, btn);
                    wrapper.appendChild(btn);
                });
            });
            updateDisplay();
        });
    </script>
</head>

<body>
    <div id="hud"></div>
    <div class="quest-card">
        <h3>‚öîÔ∏è La Qu√™te du Code Ancestral ‚öîÔ∏è</h3>
        <p style="text-align: center; font-style: italic; margin-bottom: 2rem;">"Celui qui ma√Ætrise le Legacy, ma√Ætrise
            le Monde."</p>

        <div id="story">

            <!-- 1. ENTREE -->
            <div class="section">
                <p><strong>1. L'Entr√©e du Donjon "Legacy"</strong></p>
                <p>Vous vous tenez devant une porte massive couverte de toiles d'araign√©e. Une inscription grav√©e dit :
                    "Derni√®re mise √† jour : 2003". Un vieux parchemin (README.txt) est clou√© dessus.</p>
                <button class="choice" data-mana="-5" data-xp="+5" data-karma="+5" onclick="applyChoice(this)">Lire
                    attentivement le parchemin (Documentation).</button>
                <button class="choice" data-mana="0" data-xp="+0" data-karma="-5" onclick="applyChoice(this)">Enfoncer
                    la porte en hurlant "DEPLOY TO PROD!".</button>
            </div>

            <!-- 2. GOBELIN -->
            <div class="section">
                <p><strong>2. Le Gobelin Stagiaire</strong></p>
                <p>Un petit gobelin nerveux bloque le couloir. Il tient une Pull Request tremblante. "S'il vous pla√Æt,
                    messire, can I merge? J'ai peur de casser la prod."</p>
                <button class="choice" data-mana="-5" data-xp="+10" data-karma="+10" onclick="applyChoice(this)">Faire
                    une Code Review bienveillante et corriger ses erreurs.</button>
                <button class="choice" data-mana="0" data-xp="+0" data-karma="-10" onclick="applyChoice(this)">Lui dire
                    "LGTM" sans regarder et courir.</button>
            </div>

            <!-- 3. PONT -->
            <div class="section">
                <p><strong>3. Le Pont des Tests Unitaires</strong></p>
                <p>Un gouffre sans fin barre la route. Le pont est constitu√© de dalles rouges et vertes. Certaines
                    semblent fragiles (Flaky Tests).</p>
                <button class="choice" data-mana="-5" data-xp="+10" data-karma="+10" onclick="applyChoice(this)">R√©parer
                    les dalles rouges avant de traverser.</button>
                <button class="choice" data-mana="+10" data-xp="0" data-karma="-20" onclick="applyChoice(this)">Utiliser
                    le sortil√®ge `@Ignore` et sauter par-dessus.</button>
            </div>

            <!-- 4. FORET -->
            <div class="section">
                <p><strong>4. La For√™t des Spaghettis</strong></p>
                <p>Des lianes de code s'entrem√™lent partout. Des `GOTO` pendent des arbres comme des serpents venimeux.
                </p>
                <button class="choice" data-mana="-15" data-xp="+15" data-karma="+15" onclick="applyChoice(this)">Sortir
                    l'√©p√©e du Refactoring et tailler un chemin propre.</button>
                <button class="choice" data-mana="-5" data-xp="+5" data-karma="-5" onclick="applyChoice(this)">Se
                    faufiler en ajoutant une condition `if (true)` suppl√©mentaire.</button>
            </div>

            <!-- 5. AUBERGE -->
            <div class="section">
                <p><strong>5. L'Auberge du Stack Overflow</strong></p>
                <p>Un refuge lumineux. Des voyageurs s'√©changent des solutions copi√©es-coll√©es. L'aubergiste vous
                    propose un breuvage.</p>
                <button class="choice" data-mana="+40" data-xp="0" data-karma="0" onclick="applyChoice(this)">Boire la
                    Potion de Caf√©ine (Repos long).</button>
                <button class="choice" data-mana="+20" data-xp="+10" data-karma="0" onclick="applyChoice(this)">√âcouter
                    les l√©gendes des anciens (Lire les top answers).</button>
            </div>

            <!-- 6. BASE DE DONNEES -->
            <div class="section">
                <p><strong>6. Les Cavernes de la Base de Donn√©es</strong></p>
                <p>Un dragon de cristal dort sur un tas de donn√©es non index√©es. Il grogne en SQL.</p>
                <button class="choice" data-mana="-10" data-xp="+15" data-karma="+5" onclick="applyChoice(this)">Lancer
                    un sort d'Indexation Silencieuse (`CREATE INDEX CONCURRENTLY`).</button>
                <button class="choice" data-mana="0" data-xp="-5" data-karma="-10" onclick="applyChoice(this)">Fuir
                    pendant qu'il fait un `FULL TABLE SCAN`.</button>
            </div>

            <!-- 7. ARCHITECTURE -->
            <div class="section">
                <p><strong>7. Le Sorcier de l'Architecture</strong></p>
                <p>Un vieux mage en robe blanche appara√Æt. "Ce donjon est obsol√®te ! Nous devrions tout r√©√©crire en Rust
                    ou en Go !"</p>
                <button class="choice" data-mana="-20" data-xp="+20" data-karma="0" onclick="applyChoice(this)">D√©battre
                    avec lui pendant des heures (Perte de temps mais gain de savoir).</button>
                <button class="choice" data-mana="0" data-xp="0" data-karma="+5" onclick="applyChoice(this)">Lui dire
                    "On verra √ßa en Q4" et continuer.</button>
            </div>

            <!-- 8. MIROIR -->
            <div class="section">
                <p><strong>8. Le Miroir de la R√©trospection</strong></p>
                <p>Vous voyez votre reflet... mais il code mal. Il commite directement sur main.</p>
                <button class="choice" data-mana="-5" data-xp="+5" data-karma="+10" onclick="applyChoice(this)">Accepter
                    ses erreurs pass√©es et promettre de s'am√©liorer.</button>
                <button class="choice" data-mana="-10" data-xp="0" data-karma="-5" onclick="applyChoice(this)">Briser le
                    miroir de rage.</button>
            </div>

            <!-- 9. ARMURERIE -->
            <div class="section">
                <p><strong>9. L'Armurerie Open Source</strong></p>
                <p>Des armes l√©gendaires sont au mur. Vous pouvez en prendre une pour le combat final.</p>
                <button class="choice" data-mana="-5" data-xp="+10" data-karma="0" onclick="applyChoice(this)">Prendre
                    le Bouclier Docker (Isolation).</button>
                <button class="choice" data-mana="-5" data-xp="+10" data-karma="-5" onclick="applyChoice(this)">Prendre
                    la Hache `rm -rf` (Destruction).</button>
            </div>

            <!-- 10. PORTE DEPLOIEMENT -->
            <div class="section">
                <p><strong>10. La Porte du D√©ploiement</strong></p>
                <p>Le Gardien CI/CD barre la route. "Montre-moi tes badges de couverture de code !"</p>
                <button class="choice" data-mana="-5" data-xp="+5" data-karma="+5" onclick="applyChoice(this)">Montrer
                    fi√®rement un badge √† 85%.</button>
                <button class="choice" data-mana="0" data-xp="+5" data-karma="-15" onclick="applyChoice(this)">Utiliser
                    un faux badge Photoshop.</button>
            </div>

            <!-- 11. DRAGON -->
            <div class="section">
                <p><strong>11. Le Dragon Monolithique</strong></p>
                <p>Il est immense. Ses √©cailles sont faites de classes Java de 5000 lignes. Il crache du XML.</p>
                <button class="choice" data-mana="-30" data-xp="+30" data-karma="+20"
                    onclick="applyChoice(this)">Attaque "Strangler Fig Pattern" (Remplacement progressif).</button>
                <button class="choice" data-mana="-10" data-xp="+10" data-karma="-20"
                    onclick="applyChoice(this)">Attaque "Gros Patch Sale" (Quick Fix).</button>
                <button class="choice" data-mana="-50" data-xp="0" data-karma="0"
                    onclick="applyChoice(this)">Incantation ultime : "REWRITE FROM SCRATCH" (Risque mortel).</button>
            </div>

            <!-- 12. TRESOR -->
            <div class="section">
                <p><strong>12. Le Tr√©sor (La Production)</strong></p>
                <p>Le dragon est vaincu (ou apais√©). Le coffre de la Prod est devant vous.</p>
                <button class="choice" data-mana="0" data-xp="+5" data-karma="+5"
                    onclick="applyChoice(this); computeEnding()">Ouvrir le coffre et livrer la valeur.</button>
            </div>

        </div>

        <div class="footer-nav"
            style="margin-top: 3rem; border-top: 1px solid var(--border-color); padding-top: 1rem; text-align: center;">
            <a href="../fantasy.html">&larr; Retour au Grimoire</a> |
            <a href="../index.html">Biblioth√®que Principale</a>
        </div>
    </div>
</body>

</html>